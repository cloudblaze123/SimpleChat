# 谁能决定消息时间戳？
> 最后修改于 2024-09-13 19:42


## 问题描述

需求：
1. 服务器储存消息时，需要记录消息的发送时间；
2. 客户端读取消息时，需要获取消息的发送时间。

限制：由于硬件和软件的限制，客户端时间与服务器时间不完全一致

问题：应该使用客户端的时间还是服务器的时间？




## 问题分析

### 假设使用客户端时间

#### 问题1：不同客户端的时间彼此不同步

除了客户端时间与服务器时间不同步，不同客户端的时间也可能不同步。

> 假设客户端A的时间比客户端B早1个小时（例如，客户端A的时间为9:00，客户端B的时间为10:00）。
>
> 在某一时刻，客户端A收到来自客户端B的消息，并立即回信给B。
>
> 从消息的发出顺序看，A的消息应该在B的消息之后，
>
> 但因为客户端A的时间比B早1个小时，当客户端B收到A的消息时，A消息的时间戳比B消息的时间戳也同样早了近1个小时，导致客户端B将A消息排在B消息之前。（且在之后的一个小时里，A的消息始终排在B的第一条消息之前）


#### 问题2：客户端时间不可信

如果让客户端负责设置消息的发送时间戳，那么就可以在客户端通过修改发送消息的时间戳，从而篡改服务器的消息历史。
> 例如将消息的时间戳提前，当服务器收到这条消息时，相当于给服务器插入了一条该时间的消息，从而篡改了服务器的消息历史。




## 结论

### 使用客户端时间，可能会导致：

1. 消息顺序错乱

2. 消息历史可被篡改

由于以上两点原因，使用客户端时间作为消息的发送时间戳并不可靠。




## 解决方案
### 方案一：消息时间戳使用送达服务器的时间点

客户端在发送消息时，只发送消息，发送时间戳由服务器负责记录，且为到达服务器时的服务器时间点。

#### 优点：

1. 解决了不同客户端时间不同步的问题
    > 使用服务器时间，即使客户端之间的时间不同，也可以保证消息有统一的时间标准，从而避免消息顺序错乱。

2. 减少了消息历史可被篡改的风险
    > 因为客户端只负责发送消息，并不负责记录消息的时间戳，所以即使客户端修改了消息的时间戳，也不会影响到服务器的消息历史。

#### 缺点：

待补充...




## 拓展思考

以上分析，反映了“客户端不可信”这一观点。

在管理用户的数据时，除了必须由用户决定的数据（比如用户名、发送的内容），客户端不应该再负责其余数据的记录和存储（如果必须由客户端负责，也应该始终保持对客户端数据的怀疑）